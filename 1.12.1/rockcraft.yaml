name: coredns
summary: ROCK for the CoreDNS Project.
description: This ROCK is a drop in replacement for the coredns/coredns image.
version: "1.12.1"
license: Apache-2.0

base: bare
build-base: ubuntu@22.04
platforms:
  amd64:
  arm64:

entrypoint-service: coredns
services:
  coredns:
    override: replace
    summary: "coredns service"
    startup: enabled
    command: "/coredns [ -conf /etc/coredns/Corefile ]"
    on-failure: shutdown

parts:
  coredns:
    plugin: nil
    source: https://github.com/coredns/coredns
    source-type: git
    source-tag: v1.12.1
    source-depth: 1
    build-packages:
      - build-essential
    build-snaps:
      - go/1.23-fips/stable
    stage:
      - -bin
    stage-packages:
      - ca-certificates_data
    override-build: |
      set -euo pipefail

      GITCOMMIT="${GITCOMMIT:-$(git describe --dirty --always)}"
      BINARY="${BINARY:-coredns}"
      SYSTEM="${SYSTEM:-}"
      BUILDOPTS="${BUILDOPTS:--v}"
      GOPATH="${GOPATH:-$HOME/go}"
      CGO_ENABLED="${CGO_ENABLED:-0}"

      export GOSUMDB=sum.golang.org
      export CGO_ENABLED=1
      export GOTOOLCHAIN="local"
      export GOEXPERIMENT="opensslcrypto"

      if [[ ! -f core/plugin/zplugin.go || ! -f core/dnsserver/zdirectives.go ]]; then
        echo "Generating go files..."
        go generate coredns.go
        go get
      fi

      echo "Building $BINARY with GitCommit $GITCOMMIT"
      CGO_ENABLED="$CGO_ENABLED" $SYSTEM go build $BUILDOPTS \
        -ldflags="-s -w -X github.com/coredns/coredns/coremain.GitCommit=${GITCOMMIT}" \
        -o "$BINARY"
      cp $CRAFT_PART_BUILD/coredns $CRAFT_PRIME
