name: coredns
summary: ROCK for the CoreDNS Project.
description: This ROCK is a drop in replacement for the coredns/coredns image.
version: "1.13.2"
license: Apache-2.0

base: bare
build-base: ubuntu@22.04
platforms:
  amd64:
  arm64:

entrypoint-service: coredns
services:
  coredns:
    override: replace
    summary: "coredns service"
    startup: enabled
    command: "/coredns [ -conf /etc/coredns/Corefile ]"
    on-failure: shutdown

parts:
  openssl:
    plugin: nil
    stage-packages:
      - openssl-fips-module-3 # a Pro only FIPS package for openssl
      - openssl # now automatically selected from fips-preview
  coredns:
    after: [pebble]
    plugin: nil
    source: https://github.com/coredns/coredns
    source-type: git
    source-tag: v1.13.2
    source-depth: 1
    build-packages:
      - build-essential
    build-snaps:
      - go/1.24-fips/stable
    stage-packages:
      - ca-certificates_data
    # NOTE: (mateo) Prevent the Go snap from being refreshed to 1.23-fips
    # stable by Pebble
    # https://github.com/canonical/rockcraft/blob/37ccd575371823c35e9586735962e496c3927893/rockcraft/pebble.py#L140
    override-build: |
      snap refresh go --channel=1.24-fips/stable
      make CGO_ENABLED=1 GOTOOLCHAIN=local SYSTEM="GOEXPERIMENT=opensslcrypto" BUILDOPTS="-tags 'linux,cgo,ms_tls13kdf'"
      cp $CRAFT_PART_BUILD/coredns $CRAFT_PART_INSTALL
